<!DOCTYPE html>
<html lang="pt-br">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>WAA - Workflow de Atualizações de Apólice</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" />
  <style>
    body {
      background-color: #f8f9fa;
    }
    header {
      background-color: #343a40;
      color: white;
      padding: 1rem;
      position: relative;
    }
    .notification-icon {
      position: absolute;
      top: 10px;
      right: 10px;
      width: 36px;
      height: 36px;
    }
    .description {
      padding: 1rem;
      background-color: #ffffff;
      margin-bottom: 1rem;
    }
    .form-section {
      padding: 1rem;
      background-color: #ffffff;
      margin-bottom: 1rem;
    }
    .backlog-section {
      padding: 1rem;
      background-color: #ffffff;
    }
    .status-pendente {
      background-color: #fff3cd !important;
    }
    .status-execucao {
      background-color: #d4edda !important;
    }
    .status-concluido {
      background-color: #e2e3e5 !important;
    }
    .origem-susep {
      background-color: #f8d7da !important;
    }
  </style>
</head>
<body>
  <header class="d-flex justify-content-between align-items-center">
    <div>
      <h1>WAA</h1>
    </div>
    <div>
      <button id="generateReport" class="btn btn-light">Gerar Relatório</button>
      <img id="notificationIcon" src="https://www.pngmart.com/files/22/Notification-Bell-PNG-HD.png" alt="Notificações" class="notification-icon d-none" />
    </div>
  </header>

  <div class="container mt-4">
    <div class="description">
      <p>
        Sistema criado com o objetivo de atender a disciplina de Projeto Integrador 2 no curso de Tecnologia da Informação, na UFMS - Universidade Federal de Mato Grosso do Sul.
      </p>
    </div>

    <div class="form-section">
      <form id="demandForm">
        <div class="mb-3">
          <label for="fileInput" class="form-label">Upload de Arquivo</label>
          <input class="form-control" type="file" id="fileInput" required />
        </div>
        <div class="mb-3">
          <label for="produto" class="form-label">Produto</label>
          <select class="form-select" id="produto" required>
            <option value="">Selecione</option>
            <option value="Garantia Estendida">Garantia Estendida</option>
            <option value="Roubo e Quebra de Portáteis">Roubo e Quebra de Portáteis</option>
            <option value="Residencial">Residencial</option>
            <option value="Proteção Financeira">Proteção Financeira</option>
          </select>
        </div>
        <div class="mb-3">
          <label for="origem" class="form-label">Origem</label>
          <select class="form-select" id="origem" required>
            <option value="">Selecione</option>
            <option value="Interno e SUSEP">Interno e SUSEP</option>
            <option value="SUSEP">SUSEP</option>
            <option value="Interno">Interno</option>
          </select>
        </div>
        <div class="mb-3">
          <label for="status" class="form-label">Status</label>
          <select class="form-select" id="status" required>
            <option value="">Selecione</option>
            <option value="Pendente">Pendente</option>
            <option value="Em execução">Em execução</option>
            <option value="Concluído">Concluído</option>
          </select>
        </div>
        <div class="mb-3">
          <label for="data" class="form-label">Data</label>
          <input type="text" class="form-control" id="data" readonly />
        </div>
        <div class="mb-3">
          <label for="descricao" class="form-label">Descreva quais campos sofreram atualização</label>
          <textarea class="form-control" id="descricao" rows="3" required></textarea>
        </div>
        <div class="form-check mb-3">
          <input class="form-check-input" type="checkbox" id="ajustesCumulativos" />
          <label class="form-check-label" for="ajustesCumulativos">Ajustes cumulativos</label>
        </div>
        <button type="submit" class="btn btn-primary">Enviar</button>
      </form>
    </div>
    <div class="backlog-section mt-4">
      <h3>Backlog de Demandas</h3>
      <table class="table table-bordered" id="backlogTable">
        <thead>
          <tr>
            <th>Produto</th>
            <th>Origem</th>
            <th>Status</th>
            <th>Data</th>
            <th>Descrição</th>
            <th>Download</th>
          </tr>
        </thead>
        <tbody>
          <!-- Demandas serão adicionadas aqui -->
        </tbody>
      </table>
    </div>
  </div>

  <script>
    document.addEventListener('DOMContentLoaded', () => {
      const dataInput = document.getElementById('data');
      const today = new Date().toISOString().split('T')[0];
      dataInput.value = today;

      const form = document.getElementById('demandForm');
      const backlogTableBody = document.getElementById('backlogTable').getElementsByTagName('tbody')[0];
      const notificationIcon = document.getElementById('notificationIcon');
      const demands = [];

      function updateNotificationIcon() {
        const hasCriticalPending = demands.some(d => 
          (d.origem === 'Interno e SUSEP' || d.origem === 'SUSEP') && d.status === 'Pendente'
        );
        notificationIcon.classList.toggle('d-none', !hasCriticalPending);
      }

      function createDownloadLink(filePath) {
        const link = document.createElement('a');
        link.href = filePath;
        link.textContent = 'Download';
        link.target = '_blank';
        return link;
      }

      function addDemandToTable(demand) {
        const row = backlogTableBody.insertRow();
        row.dataset.produto = demand.produto;
        row.dataset.origem = demand.origem;
        row.dataset.status = demand.status;

        const produtoCell = row.insertCell();
        produtoCell.textContent = demand.produto;

        const origemCell = row.insertCell();
        origemCell.textContent = demand.origem;

        const statusCell = row.insertCell();
        const statusSelect = document.createElement('select');
        statusSelect.className = 'form-select';
        ['Pendente', 'Em execução', 'Concluído'].forEach(status => {
          const option = document.createElement('option');
          option.value = status;
          option.textContent = status;
          if (status === demand.status) option.selected = true;
          statusSelect.appendChild(option);
        });
        statusSelect.addEventListener('change', () => {
          demand.status = statusSelect.value;
          row.dataset.status = demand.status;
          applyRowStyle(row, demand);
          updateNotificationIcon();
        });
        statusCell.appendChild(statusSelect);

        const dataCell = row.insertCell();
        dataCell.textContent = demand.data;

        const descricaoCell = row.insertCell();
        descricaoCell.textContent = demand.descricao;

        const downloadCell = row.insertCell();
        downloadCell.appendChild(createDownloadLink(demand.filePath));

        applyRowStyle(row, demand);
      }

      function applyRowStyle(row, demand) {
        row.classList.remove('status-pendente', 'status-execucao', 'status-concluido', 'origem-susep');
        if (demand.status === 'Concluído') {
          row.classList.add('status-concluido');
        } else if (demand.status === 'Em execução') {
          row.classList.add('status-execucao');
        } else if (demand.status === 'Pendente') {
          row.classList.add('status-pendente');
          if (demand.origem === 'Interno e SUSEP' || demand.origem === 'SUSEP') {
            row.classList.add('origem-susep');
          }
        }
      }

      // Evento de submit ajustado
      form.addEventListener('submit', (e) => {
        e.preventDefault();

        const fileInput = document.getElementById('fileInput');
        const produto = document.getElementById('produto').value;
        const origem = document.getElementById('origem').value;
        const status = document.getElementById('status').value;
        const data = document.getElementById('data').value;
        const descricao = document.getElementById('descricao').value;
        const ajustesCumulativos = document.getElementById('ajustesCumulativos').checked;

        if (!fileInput.files.length) {
          alert('Por favor, selecione um arquivo.');
          return;
        }

        const file = fileInput.files[0];
        const filePath = URL.createObjectURL(file);

        // Se ajustes cumulativos estiver marcado, altera demandas pendentes do mesmo produto
        if (ajustesCumulativos) {
          demands.forEach(d => {
            if (d.produto === produto && d.status === 'Pendente') {
              d.status = 'Concluído';
            }
          });
        }

        // Cria nova demanda
        const newDemand = {
          produto,
          origem,
          status,
          data,
          descricao,
          filePath
        };
        demands.push(newDemand);
        addDemandToTable(newDemand);
        updateNotificationIcon();

        // Resetar formulário
        form.reset();
        document.getElementById('data').value = today;
      });
    });
  </script>
</body>
</html>
