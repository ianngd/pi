<!DOCTYPE html>
<html lang="pt-br">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>WAA - Workflow de Atualizações de Apólice</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" />
  <style>
    body {
      background-color: #f8f9fa;
    }
    header {
      background-color: #343a40;
      color: white;
      padding: 1rem;
    }
    /* Container para o botão e o ícone com layout flexível */
    .notification-container {
      display: flex;
      align-items: center;
      gap: 10px;
      position: relative;
    }
    /* Estilo do ícone de notificação */
    #notificationIcon {
      width: 36px;
      height: 36px;
      transition: opacity 0.3s ease;
    }
    /* Estilos para as linhas do backlog baseados no status */
    tr.status-pendente {
    --bs-table-bg: #fff3cd;
    background-color: #fff3cd !important;
    }

    tr.status-execucao {
    --bs-table-bg: #d4edda;
    background-color: #d4edda !important;
    }

    tr.status-concluido {
    --bs-table-bg: #e2e3e5;
    background-color: #e2e3e5 !important;
    }

    tr.origem-susep {
    --bs-table-bg: #f8d7da;
    background-color: #f8d7da !important;
    }
    
  </style>
</head>
<body>
  <header class="d-flex justify-content-between align-items-center">
    <div>
      <h1>WAA</h1>
    </div>
    <div class="notification-container">
      <button id="generateReport" class="btn btn-light">Gerar Relatório</button>
      <img id="notificationIcon" src="https://www.pngmart.com/files/22/Notification-Bell-PNG-HD.png" alt="Notificações" class="d-none" />
    </div>
  </header>

  <div class="container mt-4">
    <div class="description p-3 mb-3 bg-white rounded">
      <p>
        Sistema criado com o objetivo de atender a disciplina de Projeto Integrador 2 no curso de Tecnologia da Informação, na UFMS - Universidade Federal de Mato Grosso do Sul.
      </p>
    </div>

    <div class="form-section p-3 mb-3 bg-white rounded">
      <form id="demandForm">
        <div class="mb-3">
          <label for="fileInput" class="form-label">Upload de Arquivo</label>
          <input class="form-control" type="file" id="fileInput" required />
        </div>
        <div class="mb-3">
          <label for="produto" class="form-label">Produto</label>
          <select class="form-select" id="produto" required>
            <option value="">Selecione</option>
            <option value="Garantia Estendida">Garantia Estendida</option>
            <option value="Roubo e Quebra de Portáteis">Roubo e Quebra de Portáteis</option>
            <option value="Residencial">Residencial</option>
            <option value="Proteção Financeira">Proteção Financeira</option>
          </select>
        </div>
        <div class="mb-3">
          <label for="origem" class="form-label">Origem</label>
          <select class="form-select" id="origem" required>
            <option value="">Selecione</option>
            <option value="Interno e SUSEP">Interno e SUSEP</option>
            <option value="SUSEP">SUSEP</option>
            <option value="Interno">Interno</option>
          </select>
        </div>
        <div class="mb-3">
          <label for="status" class="form-label">Status</label>
          <select class="form-select" id="status" required>
            <option value="">Selecione</option>
            <option value="Pendente">Pendente</option>
            <option value="Em execução">Em execução</option>
            <option value="Concluído">Concluído</option>
          </select>
        </div>
        <div class="mb-3">
          <label for="data" class="form-label">Data</label>
          <input type="text" class="form-control" id="data" readonly />
        </div>
        <div class="mb-3">
          <label for="descricao" class="form-label">Descreva quais campos sofreram atualização</label>
          <textarea class="form-control" id="descricao" rows="3" required></textarea>
        </div>
        <div class="form-check mb-3">
          <input class="form-check-input" type="checkbox" id="ajustesCumulativos" />
          <label class="form-check-label" for="ajustesCumulativos">Ajustes cumulativos</label>
        </div>
        <button type="submit" class="btn btn-primary">Enviar</button>
      </form>
    </div>

    <div class="backlog-section p-3 bg-white rounded">
      <h3>Backlog de Demandas</h3>
      <table class="table table-bordered" id="backlogTable">
        <thead>
          <tr>
            <th>Produto</th>
            <th>Origem</th>
            <th>Status</th>
            <th>Data</th>
            <th>Descrição</th>
            <th>Download</th>
          </tr>
        </thead>
        <tbody>
          <!-- Demandas serão adicionadas aqui -->
        </tbody>
      </table>
    </div>
  </div>

  <script>
    document.addEventListener('DOMContentLoaded', () => {
      const dataInput = document.getElementById('data');
      const today = new Date().toISOString().split('T')[0];
      dataInput.value = today;

      const form = document.getElementById('demandForm');
      const backlogTbody = document.getElementById('backlogTable').getElementsByTagName('tbody')[0];
      const notificationIcon = document.getElementById('notificationIcon');
      const generateReportBtn = document.getElementById('generateReport');

      let demands = [];

      // Função para atualizar o ícone de notificações
      function updateNotificationIcon() {
        const hasCriticalPending = demands.some(d => 
          (d.origem === 'Interno e SUSEP' || d.origem === 'SUSEP') && d.status === 'Pendente'
        );
        notificationIcon.classList.toggle('d-none', !hasCriticalPending);
      }

      // Criar link de download
      function createDownloadLink(filePath) {
        const link = document.createElement('a');
        link.href = filePath;
        link.textContent = 'Download';
        link.target = '_blank';
        return link;
      }

      // Adicionar demanda na tabela
      function addDemandToTable(demand) {
        const row = backlogTbody.insertRow();
        row.dataset.produto = demand.produto;
        row.dataset.origem = demand.origem;
        row.dataset.status = demand.status;

        const produtoCell = row.insertCell();
        produtoCell.textContent = demand.produto;

        const origemCell = row.insertCell();
        origemCell.textContent = demand.origem;

        const statusCell = row.insertCell();
        const statusSelect = document.createElement('select');
        statusSelect.className = 'form-select';
        ['Pendente', 'Em execução', 'Concluído'].forEach(status => {
          const option = document.createElement('option');
          option.value = status;
          option.textContent = status;
          if (status === demand.status) option.selected = true;
          statusSelect.appendChild(option);
        });
        statusSelect.addEventListener('change', () => {
          demand.status = statusSelect.value;
          row.dataset.status = demand.status;
          applyRowStyle(row, demand);
          updateNotificationIcon();
        });
        statusCell.appendChild(statusSelect);

        const dataCell = row.insertCell();
        dataCell.textContent = demand.data;

        const descricaoCell = row.insertCell();
        descricaoCell.textContent = demand.descricao;

        const downloadCell = row.insertCell();
        downloadCell.appendChild(createDownloadLink(demand.filePath));

        applyRowStyle(row, demand);
      }

      // Aplicar estilos às linhas conforme o status
      function applyRowStyle(row, demand) {
        row.classList.remove('status-pendente', 'status-execucao', 'status-concluido', 'origem-susep');
        if (demand.status === 'Concluído') {
          row.classList.add('status-concluido');
        } else if (demand.status === 'Em execução') {
          row.classList.add('status-execucao');
        } else if (demand.status === 'Pendente') {
          row.classList.add('status-pendente');
          if (demand.origem === 'Interno e SUSEP' || demand.origem === 'SUSEP') {
            row.classList.add('origem-susep');
          }
        }
      }

      // Evento de submissão do formulário
      form.addEventListener('submit', (e) => {
        e.preventDefault();
        const fileInput = document.getElementById('fileInput');
        const produto = document.getElementById('produto').value;
        const origem = document.getElementById('origem').value;
        const status = document.getElementById('status').value;
        const data = document.getElementById('data').value;
        const descricao = document.getElementById('descricao').value;
        const ajustesCumulativos = document.getElementById('ajustesCumulativos').checked;

        if (!fileInput.files.length) {
          alert('Por favor, selecione um arquivo.');
          return;
        }

        const filePath = URL.createObjectURL(fileInput.files[0]);

        // Se ajustes cumulativos estiver marcado, atualiza o status das pendentes do mesmo produto
        if (ajustesCumulativos) {
          demands.forEach(d => {
            if (d.produto === produto && d.status === 'Pendente') {
              d.status = 'Concluído';
            }
          });
          // Recria a tabela
          backlogTbody.innerHTML = '';
          demands.forEach(d => addDemandToTable(d));
        }

        // Adiciona a nova demanda
        const newDemand = { produto, origem, status: 'Pendente', data, descricao, filePath };
        demands.push(newDemand);
        addDemandToTable(newDemand);
        updateNotificationIcon();

        // Resetar formulário
        form.reset();
        document.getElementById('data').value = today;
      });

      // Botão de gerar relatório (exemplo simples de CSV)
      document.getElementById('generateReport').addEventListener('click', () => {
        if (demands.length === 0) {
          alert('Nenhuma demanda para gerar relatório.');
          return;
        }
        const csvHeader = ['Produto', 'Origem', 'Status', 'Data', 'Descrição', 'Arquivo'];
        const csvRows = demands.map(d => [
          `"${d.produto}"`,
          `"${d.origem}"`,
          `"${d.status}"`,
          `"${d.data}"`,
          `"${d.descricao}"`,
          `"${d.filePath}"`
        ]);
        const csvContent = [csvHeader, ...csvRows].map(e => e.join(';')).join('\n');
        const blob = new Blob(["\ufeff" + csvContent], { type: 'text/csv;charset=utf-8;' });
        const url = URL.createObjectURL(blob);
        const link = document.createElement('a');
        link.href = url;
        link.download = `relatorio_${today}.csv`;
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
      });

      // Atualiza o ícone de notificações ao carregar a página
      updateNotificationIcon();
    });
  </script>
</body>
</html>